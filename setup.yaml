AWSTemplateFormatVersion: 2010-09-09
Description: Your Delivery Template
Parameters:
  SNSTopicName:
    Type: String
    Description: Name of the SNS topic
    Default: delivery
  NotificationQueueName:
    Type: String
    Description: Name of the Notification Queue
    Default: notification
  InventoryQueueName:
    Type: String
    Description: Name of the Inventory Queue
    Default: inventory
  ShipmentQueueName:
    Type: String
    Description: Name of the Shipment Queue
    Default: shipment
  InstanceType:
    Type: String
    Description: EC2 instances size
    Default: t2.micro
  ImageId:
    Type: String
    Description: EC2 instances image id
    Default: ami-07ce6ac5ac8a0ee6f
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an EC2 KeyPair to enable SSH access to the instance
    Default: your-delivery
  SshPort:
    Type: Number
    Description: Bastion Host SSH port
    Default: 22
    MinValue: 22
    MaxValue: 65535
  SourceCidr:
    Type: String
    Description: CIDR Block of IPv4 IP addresses allowed to access Bastion Host via SSH
    AllowedPattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(/([0-9]|[1-2][0-9]|3[0-2]))?$"
    ConstraintDescription: The value must be valid IPv4 CIDR block.
    Default: 0.0.0.0/32
Resources:
  SNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Ref SNSTopicName
      TopicName: !Ref SNSTopicName
  NotificationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref NotificationQueueName
  NotificationQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt NotificationQueue.Arn
      Protocol: sqs
      TopicArn: !Ref SNSTopic
      FilterPolicy:
        type:
          - NOTIFICATION
      FilterPolicyScope: MessageBody
  InventoryQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref InventoryQueueName
  InventoryQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt InventoryQueue.Arn
      Protocol: sqs
      TopicArn: !Ref SNSTopic
      FilterPolicy:
        type:
          - INVENTORY
      FilterPolicyScope: MessageBody
  ShipmentQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref ShipmentQueueName
  ShipmentQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt ShipmentQueue.Arn
      Protocol: sqs
      TopicArn: !Ref SNSTopic
      FilterPolicy:
        type:
          - SHIPMENT
      FilterPolicyScope: MessageBody
  QueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - Ref: NotificationQueue
        - Ref: InventoryQueue
        - Ref: ShipmentQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - sqs:SendMessage
              - sqs:ReceiveMessage
            Resource: "*"
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref SNSTopic
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.16.0.0/24
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: your-delivery-vpc
  InternetGateway:
    Type: "AWS::EC2::InternetGateway"
    Properties:
      Tags:
        - Key: Name
          Value: your-delivery-igw
  InternetGatewayAttachment:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  BackendRouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: your-delivery-rt-backend
  BackendRouteTableDefaultIPv4:
    Type: "AWS::EC2::Route"
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref BackendRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  BackendRouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId: !Ref BackendSubnet
      RouteTableId: !Ref BackendRouteTable
  BackendSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.16.0.0/27
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: your-delivery-sn-backend
  BastionHostRouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: your-delivery-rt-bastion-host
  BastionHostRouteTableDefaultIPv4:
    Type: "AWS::EC2::Route"
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref BastionHostRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  BastionHostRouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId: !Ref BastionHostSubnet
      RouteTableId: !Ref BastionHostRouteTable
  BastionHostSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.16.0.32/27
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: your-delivery-sn-bastion-host
  BackendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: A Security Group for Backend
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref BastionHostSecurityGroup
          FromPort: !Ref SshPort
          ToPort: !Ref SshPort
          IpProtocol: tcp
  BastionHostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: A Security Group for Bastion Host
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - CidrIp: !Ref SourceCidr
          FromPort: !Ref SshPort
          ToPort: !Ref SshPort
          IpProtocol: tcp
  ProducerEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref BackendSubnet
      SecurityGroupIds:
        - !Ref BackendSecurityGroup
      KeyName: !Ref KeyPairName
      Tags:
        - Key: Name
          Value: producer-ec2
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo amazon-linux-extras install java-openjdk11 -y
          sudo yum install docker -y
          sudo service docker start
          sudo usermod -a -G docker ec2-user
          sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          cd /home/ec2-user
          mkdir your-delivery-producer
          cd your-delivery-producer
          export SNS_TOPIC_ARN="${SNSTopic}"
          echo "version: '3.7'
          services:
            your-delivery-producer:
              restart: on-failure
              image: jooki997/your-delivery-producer:1.0.0
              ports:
                - 8090:8090
              environment:
                - SPRING_ACTIVE_PROFILE=default
                - TOPIC_ARN=$SNS_TOPIC_ARN
                - ACCESS_KEY=ACCESS_KEY
                - SECRET_ACCESS_KEY=SECRET_ACCESS_KEY
              container_name: producer
          " > docker-compose.yaml
          sed "s/SNS_TOPIC_ARN/$SNS_TOPIC_ARN/g" -i docker-compose.yaml
          sudo /usr/local/bin/docker-compose up -d
  NotificationQueueConsumerEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref BackendSubnet
      SecurityGroupIds:
        - !Ref BackendSecurityGroup
      KeyName: !Ref KeyPairName
      Tags:
        - Key: Name
          Value: notification-queue-consumer-ec2
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo amazon-linux-extras install java-openjdk11 -y
          sudo yum install docker -y
          sudo service docker start
          sudo usermod -a -G docker ec2-user
          sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          cd /home/ec2-user
          mkdir your-delivery-consumer
          cd your-delivery-consumer
          export SQS_NOTIFICATION_QUEUE_URL="${NotificationQueue}"
          echo "version: '3.7'
          services:
            your-delivery-consumer:
              restart: on-failure
              image: jooki997/your-delivery-consumer:1.0.0
              ports:
                - 8095:8095
              environment:
                - SPRING_ACTIVE_PROFILE=default
                - QUEUE_URL=$SQS_NOTIFICATION_QUEUE_URL
                - ACCESS_KEY=ACCESS_KEY
                - SECRET_ACCESS_KEY=SECRET_ACCESS_KEY
              container_name: consumer
          " > docker-compose.yaml
          sed "s/SQS_NOTIFICATION_QUEUE_URL/$SQS_NOTIFICATION_QUEUE_URL/g" -i docker-compose.yaml
          sudo /usr/local/bin/docker-compose up -d
  InventoryQueueConsumerEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref BackendSubnet
      SecurityGroupIds:
        - !Ref BackendSecurityGroup
      KeyName: !Ref KeyPairName
      Tags:
        - Key: Name
          Value: inventory-queue-consumer-ec2
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo amazon-linux-extras install java-openjdk11 -y
          sudo yum install docker -y
          sudo service docker start
          sudo usermod -a -G docker ec2-user
          sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          cd /home/ec2-user
          mkdir your-delivery-consumer
          cd your-delivery-consumer
          export SQS_INVENTORY_QUEUE_URL="${InventoryQueue}"
          echo "version: '3.7'
          services:
            your-delivery-consumer:
              restart: on-failure
              image: jooki997/your-delivery-consumer:1.0.0
              ports:
                - 8095:8095
              environment:
                - SPRING_ACTIVE_PROFILE=default
                - QUEUE_URL=$SQS_INVENTORY_QUEUE_URL
                - ACCESS_KEY=ACCESS_KEY
                - SECRET_ACCESS_KEY=SECRET_ACCESS_KEY
              container_name: consumer
          " > docker-compose.yaml
          sed "s/SQS_INVENTORY_QUEUE_URL/$SQS_INVENTORY_QUEUE_URL/g" -i docker-compose.yaml
          sudo /usr/local/bin/docker-compose up -d
  ShipmentQueueConsumerEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref BackendSubnet
      SecurityGroupIds:
        - !Ref BackendSecurityGroup
      KeyName: !Ref KeyPairName
      Tags:
        - Key: Name
          Value: shipment-queue-consumer-ec2
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo amazon-linux-extras install java-openjdk11 -y
          sudo yum install docker -y
          sudo service docker start
          sudo usermod -a -G docker ec2-user
          sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          cd /home/ec2-user
          mkdir your-delivery-consumer
          cd your-delivery-consumer
          export SQS_SHIPMENT_QUEUE_URL="${ShipmentQueue}"
          echo "version: '3.7'
          services:
            your-delivery-consumer:
              restart: on-failure
              image: jooki997/your-delivery-consumer:1.0.0
              ports:
                - 8095:8095
              environment:
                - SPRING_ACTIVE_PROFILE=default
                - QUEUE_URL=$SQS_SHIPMENT_QUEUE_URL
                - ACCESS_KEY=ACCESS_KEY
                - SECRET_ACCESS_KEY=SECRET_ACCESS_KEY
              container_name: consumer
          " > docker-compose.yaml
          sed "s/SQS_SHIPMENT_QUEUE_URL/$SQS_SHIPMENT_QUEUE_URL/g" -i docker-compose.yaml
          sudo /usr/local/bin/docker-compose up -d
  BastionHostEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref BastionHostSubnet
      SecurityGroupIds:
        - !Ref BastionHostSecurityGroup
      KeyName: !Ref KeyPairName
      Tags:
        - Key: Name
          Value: bastion-host-ec2
