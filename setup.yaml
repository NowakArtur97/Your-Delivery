AWSTemplateFormatVersion: 2010-09-09
Description: Your Delivery Template
Parameters:
  SNSTopicName:
    Type: String
    Description: Name of the SNS topic
    Default: delivery
  NotificationQueueName:
    Type: String
    Description: Name of the Notification Queue
    Default: notification
  InventoryQueueName:
    Type: String
    Description: Name of the Inventory Queue
    Default: inventory
  ShipmentQueueName:
    Type: String
    Description: Name of the Shipment Queue
    Default: shipment
  InstanceType:
    Type: String
    Description: EC2 instances size
    Default: t2.micro
  ImageId:
    Type: String
    Description: EC2 instances image id
    Default: ami-07ce6ac5ac8a0ee6f
Resources:
  SNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Ref SNSTopicName
      TopicName: !Ref SNSTopicName
  NotificationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref NotificationQueueName
  NotificationQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt NotificationQueue.Arn
      Protocol: sqs
      TopicArn: !Ref SNSTopic
      FilterPolicy:
        type:
          - NOTIFICATION
      FilterPolicyScope: MessageBody
  InventoryQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref InventoryQueueName
  InventoryQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt InventoryQueue.Arn
      Protocol: sqs
      TopicArn: !Ref SNSTopic
      FilterPolicy:
        type:
          - INVENTORY
      FilterPolicyScope: MessageBody
  ShipmentQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref ShipmentQueueName
  ShipmentQueueSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt ShipmentQueue.Arn
      Protocol: sqs
      TopicArn: !Ref SNSTopic
      FilterPolicy:
        type:
          - SHIPMENT
      FilterPolicyScope: MessageBody
  QueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - Ref: NotificationQueue
        - Ref: InventoryQueue
        - Ref: ShipmentQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - sqs:SendMessage
              - sqs:ReceiveMessage
            Resource: "*"
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref SNSTopic
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.16.0.0/24
      Tags:
        - Key: Name
          Value: your-delivery-vpc
  SubnetBackend:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.16.0.0/27
      Tags:
        - Key: Name
          Value: your-delivery-sn-backend
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref SubnetBackend
